[done] maximum people fed, billions for outdoor growing
[done] check 26.7 billion whether it's correct
[done] try to figure out how to smooth no resilient foods graph
[done] change everything to calories per person per day
[done] double check greenhouses are correctly tripled month 42 to 80ish
    42: 438 calories (times 3 equals 1314)
    80ish: 1287 to 1879
[done] use 2 months at 7.8 in dry caloric tons witheld for transit [mike will do this]
[done] 3 years of industrial foods, then stop.
[done] limit plots to roughly 60 months

[done] display plots where roughly 8 billion are fed

[done] add the correct meat ratio for the percentage that can be fed

[done] figure out why it doesn't seem to properly store the first month of crops food

[done] check if no rain in tropics is right (it probably isn't)

[done] figure out why my milk fat and pritein calculation seems to require 1000x more than naively assume (dividing by 1e3 rather than 1e6)


[done]modify additive factor to be monthly

[done] kcals_to_add = -excess_kcals[m] + meat_kcals[m]+ h_e_fed_dairy_kcals[m]
h_e_fed_balance_kcals[m] = -excess_kcals[m] + meat_kcals[m]+ h_e_fed_dairy_kcals[m]

[done]module(dairy_cows_from_grass[m],excess_kcals[m],constants)
    ...
    return (meat_kcals[m],meat_fat[m],meat_protein[m], h_e_fed_dairy_kcals[m], h_e_fed_dairy_fat[m], h_e_fed_dairy_protein[m])

[done]make monthly

[done]redirect excess human edible calories to remaining dairy animals first, before directing them to pigs/chickens.

[done]pass dairy animals fed to the module which calculates human edible kcals/fat/protein used and produced per month. The minimum number of dairy fed from pasture determines the maximum amount of h_e_feed to dairy, and thus the minimum number of chicken/pork (and possibly cattle) calories that can be maintained. We'll assume the number of chicken/pork herd can rise and fall over time and for now assume each month there's some excess past 7.8 billion that is used for chicken/pork.

[done] create a module which calculates fraction of livestock to cull, and calculates conversion between h_c_kcals to animals and meat output

[done]add livestock usage of protein and fat using human requirements for protein and zero fat to the module that converts between h_e_feed and h_e_fed_meat

[done]add excess to the fraction seaweed is used for

[done]remove excess multiplier on constants

[done] break out the constants file

[done] add in reduction in stored food from biofuels and food fed to animals

[done] make before, no-resilient, sensitivity, and resilient consistent in terms of variables modified

[done]add the proper values from the spreadsheets to all these

[done]ensure there is a separate run for "primary production before waste", "Caloric Sources Minus Waste and Temporarily Maintained Feed and Biofuel", and "predicted with Temporarily Maintained Feed and Biofuel diets and reduction in feed feeding all excess food to animals"

[done]title: Primary production before waste, [present-day/no deployment/resilient food deployment]
caption: food production not using human edible sources, only on-farm waste incorporated

[done]title: Food available after waste, feed ramp down and biofuel ramp down, [no resilient foods/ + resilient foods]
caption:caloric supply per capita assuming culling of all animals after X months and biofuel shutoff after Y months. Waste is assumed to reduce from present-day levels.

[done]make the run model before work with present-day values and biofuels, so that we reflect present-day diets with the model. This allows me to check whether my calculations spit something reasonable out. We can get a better sense of the improvement in terms of actual usage by swapping meat products over to other more efficient systems (dairy/milk).
    [done]fix inedible over time
    [done]add biofuels as a monthly value that can be used to turn off things
    [done]change ordering of meat feed for animals and meat feed for residue
[done] title: Baseline around 2020 average diet
caption: present-day average diet predicted by the optimizer based on year 2020 (2019?) values. Availability was determined by subtracting feed and biofuel usage as well as waste from production numbers.

[done]updated numbers: mike sent me a spreadsheet with outdoor growing estimates for 2020 of agricultural output with fat and protein.

[done]use spreadsheet trend 2015-2019

[done]fix the problem where excess outdoor growing values from first few months are transfered on to later months with the wrong number of calories/fat/protein

[done]set a couple more reasonable bounds for the monte carlo and have a list of question for it

[done]check numbers for meat and dairy in 2020 match up https://docs.google.com/spreadsheets/d/1rYcxSe-Z7ztvW-QwTBXT8GABaRmVdDuQ05HXmTHbQ8I/edit#gid=1141282747

[done] try to fix over-calories issue in diet plot when 10 million tons of fat are fed to biofuels

[done]I'm not sure if we really should be adding retail waste to any of these primary production scenarios... I think it could probably be added on the plot for ratios to feed 7.8 billion going forward instead. That might give people the wrong overall idea though? also then the optimization would improperly allocate

[done]fix issue with fat taking more than 100% of production

[done]run the simulation for present-day to check that a similar number of people eating meat is predicted as actually do
    
[done] add a separate run where biofuels and feed are added in

[done] Add up the flows and make it work so primary demand from people plus waste, plus human edible feed, plus biofuels adds to the primary production.

[done] title: Average diet, excess production used for feed, + resilient foods
caption: expected global average diet, assuming biofuels shutoff after X months and present-day levels of animal feed maintained for Y months. After  month Y, availability over 2100 kcals per capita goes preferentially to milk production, then chicken and pork meat production, then cattle meat production. [Waste is assumed to reduce from present-day levels.]


Required changes to establish people fed present-day:
    analysis:

        [done]remove h_e_fraction_X_fed_to_humans from:
            [done] billions_fed_GH
            [done] billions_fed_fish
            [done] billions_fed_CS
            [done] billions_fed_SCP
            [done] billions_fed_meat
            [done] billions_fed_milk
            [done] billions_fed_seaweed
            
        [done] update h_e_fraction_X by only including OG and SF instead of humans_fed_X

        [done] update h_e_fraction_X to OG_SF_fraction_X

        [done] only including OG and SF in sum_sources

        [done] write function to calculate part of the OG and SF result before the reduction from use

    optimizer:
        [done] change compute_excess_after_run function call
        [done] change excess constraint to only include og + sf 


Required changes to establish people fed present-day:
    [done]remove waste from the SF and OG constants
    [done]split any analysis mention of balance into excess and h_e_food
    [done]apply crops waste to any independent excess value in optimizer 
    [done]apply crops waste to any independent excess value in analysis 
    add waste and subtract biofuels from the people_fed variables
        [done] for kcals
        [done] for fat
        [done] for protein
    [done] add the waste into the analysis section for SF and OG
 
[done]figure out why fat doesn't add up to around 8 billion
[done]figure out why protein doesn't add up to around 8 billion

[done]determine why the eaten from stored food before catastrophe is positive for the very first month

[done]try to get the recursive reduction thing to assign stored food+outdoor growing to meat, in accordance with caloric surplus, for first 48 months

[done] do the math for if I need to alter the excess to incorporate biofuels delays in analysis compute_excess_after_run


[done]Required changes to properly incorporate new yields for outdoor growing:
    [done]Determine maize, canola, potato, and wheat mass per dry matter or kcals per dry matter

    [done]Multiply by the percent reduction in these crops to get the actual kcals fat, protein
    [done]Multiply by the percent reduction in a rotation with maize, soybean, wheat, rice and get the percent reduction.
    [done]Put in the new numbers for the rotation 
    [done]Add an updated rotation of the crops with 33/33/17/17.

[done] figure out crops that allow enough protein so protein and fat are not the limiting factors.



write up remaining parts of paper:
    [done] [morgan] explain the estimates made for crop growth (supplement)
    [done] [morgan] update the results section to describe results
    [done] [morgan] explanation of seaweed growth algorithm (supplement)
    [done] [morgan] explanation of the software model architecture (main paper)
    [done] [morgan] monte carlo bounds (supplement)
    [done] [morgan] monte carlo results (main paper)

[done]run the monte-carlo with new values set
    mc:
        3x greenhouse production 
        (look into gh upper and lower bounds based on alaskan potato growing)
        
        industrial 60 140 is fine
        
        upper bound delay:
            industrial: 6 months, gh: 4 months, seaweed: 2 months, crops rotation: 11 months

        estimated delay:
            industrial: 3 months, gh: 2 months, seaweed: 1 months, crops rotation: 9 months

        lower bound delay:
            industrial: 1, gh: 1 month, seaweed: 0 months, crops rotation: 8 months


    [morgan] Send email to people we'd like to review the paper before submission
        Tony Barrett monte-carlo
        IFPRI people?
        Joshua


    [morgan] determine who to suggest as reviewers
        Gal rutgers lead
        Heinan grad student of gal
        cer76@cam.ac.uk
        Catherine Richards





[done] Finish this message: Another piece of evidence something fishy is going on is when I run the before_resilient_foods case with the full 23.48 billion fed before waste including fish, primary meat production, and outdoor growing, I only get enough fat to feed 14.5 billion, so then the question is where is all the fat coming from to feed animals, biofuels, and 7.8 billion people 


[done] add culled meat




[done] update monte carlo to produce random values along lognormal and normal distributions

    run and update manuscript with monte carlo changes

add in feed delay for monte carlo for culled meat
double check culled meat is properly working
    in run_model.py => 12 months evenly
    in run_model.py => correct fraction (all meat) is used
    in run_model_no_resilient_foods.py => 12 months evenly
    in run_model_no_resilient_foods.py => correct fraction (all meat) is used


[done] add statistical box and whiskers for monte carlo results
add per month in lognormal plots
add colors to monte carlo results 
[done] industrial foods scale factor

update plot title to include 50% rather than "bad"

ask juan to check confidence bars are consistent

clarify we are not considering relocation to tobacco crop areas

table with:
    95% confidence
    mean
    max
    min
    standard deviation
    type of distribution


create the jupyter notebooks for the integrated model

code cleanup on integrated model from jaz
- Python constants code could use better documentation of units
- Should use logger to control printouts instead of commenting code
- Would be helpful to distinguish between raw input values, calculated values, and model input values
- Consider for loops for annual/month calculations
- at the very least, make the sections have clear and long start/end comments to visually break up the code
- Document functions (inputs, outputs, operations)
- Consider using conversion constants instead of magic numbers
- Need more descriptive variable constants (single letter ones like "s" and "c" are unclear)


=== eventually... ===

cleanup on integrated model code from Jaz
- Prefer to not return large arrays from internal functions  (get_meat_milk_from_excess) - set member values instead
- Consider breaking calculations up into objects or files instead of breaking up by comments
- Prefer objects with fields instead of string-based dictionaries (will help with code completion too)

figure out why optimizer fails occasionally on monte carlo (but not old sensitivity analysis)

check with juan that industrial foods did not include any delays implicitly

[done] combine the 7 plots into a graphic and add captions


fix how culled works when there's an excess of calories so that it doesn't magically add meat without taking it away

double check everything...

setting seaweed delay above around 11 months breaks the solve 

if ricky gives me new baseline, update numbers

double check wheat maize potatoes rapeseed are the best options

correct the 2005 cropland estimate to current cropland from DSSAT estimate

correct the DSSAT estimate by checking DSSAT production in normal year matches estimated production

remove redundant OG_ROTATION_FRACTION_KCALS

get rid of messy stuff with excess calculator function in analysis

determine average improvements on crop yields in alaskan/cold weather greenhouses for upper/lower bounds

get all the modules working on different folders and commit cropopt repo

fix the 1.5 multiplier on rotations

add a way to store arbitrary fat/protein/kcal foods with OG at any point in time

fix the edge cases with low fat levels or protein when you try to solve the diet and it tends to fail assertions or loop up to 30 and skip over 7.8 (generally, uses excess calories even if there's not enough fat/protein, and that doesn't work with the iteration)

double check marine fish

by monday: fix wierd tav and amp values

alter the values with mike's numbers so they do actually add up to the 7.8 billion or greater number


make an optimization on fat or protein (whatever is lower) given fixed caloric output


make a pie plot of how much each different intervention saves lives under a range of assumptions

make Monte Carlo not take forever to make values

for prettier results make the predictions iteratively add smoothness until it starts to reduce number of people fed by >1% or so, in which case stop smoothing

update the commented sections of calc_fraction_OG_SF_to_humans 

figure out why the 2020 baseline seems to predict less fat and more protein and kcals than seem to be actually consumed. {'fat': 7.54, 'kcals': 8.64, 'protein': 8.56}

alter the nutritional profile of stored foods so that they reflect the true value rather than outdoor growing, and find out how to deal with lower fat and protein in stored food causing the total people fed line to not be flat (kcals exceed protein/fat) in the 2020 baseline case


determine whether to incorporate seaweed or industrial foods as an animal feed source

change all the values from billions of kcals to thousand dry caloric tons

alter all the WASTE so they are uniformly defined as 1-number/100 when passed in as constants from run_model_xxx.py

deal with the case of nmonths being less than initial harvest

potentially associatesome cost or minimum for available food storage

add a more useful validation feature which takes a reasonable maximum for each variable and ensures the difference is less than a given fraction of that

deal with edge case feed delay < biofuel delay

alter code so that the case of non-limiting fat and protein would still work with the iterative diet calculator 

figure out optimizer to determine optimal rotation percentages.

appears to be some  edge case where get bug in code analysis line 908 assert((OG_SF_fraction_kcals_to_feed <= 1+ 1e-5).all())
